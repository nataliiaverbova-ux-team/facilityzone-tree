<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Zones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 200px;
            background: #e8e8ed;
            padding: 24px 0;
            border-right: 1px solid #d2d2d7;
        }

        .sidebar-item {
            padding: 12px 24px;
            cursor: pointer;
            color: #6e6e73;
            transition: background 0.2s;
        }

        .sidebar-item:first-child {
            background: #d2d2d7;
            color: #1d1d1f;
            font-weight: 500;
        }

        .sidebar-item:hover {
            background: #d2d2d7;
        }


        /* Main Content */
        .main-content {
            flex: 1;
            padding: 32px;
            overflow-x: auto;
        }

        .breadcrumb {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .breadcrumb a {
            color: #666;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title-section {
            flex: 1;
            min-width: 300px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .page-description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2c3e50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1a252f;
        }

        .btn-secondary {
            background: white;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #f5f5f7;
        }

        /* Table */
        .zones-table {
            background-color: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            grid-template-columns: 2fr 2fr 2fr 120px;
            background-color: #f8f8f8;
            border-bottom: 2px solid #d0d0d0;
            font-weight: 600;
            font-size: 13px;
        }

        .table-header > div {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-icon {
            width: 16px;
            height: 16px;
            background-color: #666;
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            cursor: pointer;
            position: relative;
        }

        .zone-row {
            display: grid;
            grid-template-columns: 2fr 2fr 2fr 120px;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
            min-height: 56px;
        }

        .zone-row:last-child {
            border-bottom: none;
        }

        .zone-cell {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zone-name-cell {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toggle-btn {
            width: 20px;
            height: 20px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            flex-shrink: 0;
        }

        .toggle-btn:hover {
            background-color: #f0f0f0;
            border-radius: 3px;
        }

        .toggle-btn.hidden {
            visibility: hidden;
        }

        .zone-name {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-zone-btn {
            width: 20px;
            height: 20px;
            background: none;
            border: 1.5px solid #666;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            flex-shrink: 0;
        }

        .add-zone-btn:hover {
            background-color: #333;
            border-color: #333;
            color: white;
        }

        .indent-1 { padding-left: 48px; }
        .indent-2 { padding-left: 80px; }

        .relation-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background-color: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .category-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .color-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            flex-shrink: 0;
        }

        .menu-btn {
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 18px;
            color: #666;
        }

        .menu-btn:hover {
            background-color: #f0f0f0;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 160px;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: #f8f8f8;
        }

        .context-menu-item.danger {
            color: #d32f2f;
        }

        /* Modal/Dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background-color: #f0f0f0;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .required {
            color: #d32f2f;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #2c3e50;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-input {
            width: 60px;
            height: 40px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            background-color: transparent;
            color: #666;
            border: none;
        }

        .btn-cancel:hover {
            background-color: #f0f0f0;
        }

        /* Popover */
        .popover {
            position: absolute;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 16px;
            max-width: 320px;
            z-index: 1500;
            display: none;
            font-size: 14px;
        }
        .popover a{
            color: #2E5FEE;
            display: block;
            padding: 8px 0px;
        }

        .popover.active {
            display: block;
        }

        .popover-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .popover-content {
            font-size: 14px;
            line-height: 1.6;
            color: #666;
        }

        .popover-image {
            margin-top: 12px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #666;
        }

        .empty-state-description {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .table-header,
            .zone-row {
                grid-template-columns: 1.5fr 1.5fr 1.5fr 100px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                padding: 16px;
            }

            .page-header {
                flex-direction: column;
            }

            .table-header,
            .zone-row {
                grid-template-columns: 1fr 1fr 1fr 80px;
                font-size: 12px;
            }

            .zone-cell {
                padding: 12px 8px;
            }
        }

        @media (max-width: 640px) {
            .layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #d0d0d0;
            }

            .sidebar-item {
                display: inline-block;
                padding: 12px 16px;
            }

            .table-header > div:nth-child(2),
            .zone-row .zone-cell:nth-child(2) {
                display: none;
            }

            .table-header,
            .zone-row {
                grid-template-columns: 2fr 1.5fr 80px;
            }
        }

        .hidden-row {
            display: none;
        }
    </style>
</head>
<script>
(function (m, a, z, e) {
  var s, t, u, v;
  try {
    t = m.sessionStorage.getItem('maze-us');
  } catch (err) {}

  if (!t) {
    t = new Date().getTime();
    try {
      m.sessionStorage.setItem('maze-us', t);
    } catch (err) {}
  }

  u = document.currentScript || (function () {
    var w = document.getElementsByTagName('script');
    return w[w.length - 1];
  })();
  v = u && u.nonce;

  s = a.createElement('script');
  s.src = z + '?apiKey=' + e;
  s.async = true;
  if (v) s.setAttribute('nonce', v);
  a.getElementsByTagName('head')[0].appendChild(s);
  m.mazeUniversalSnippetApiKey = e;
})(window, document, 'https://snippet.maze.co/maze-universal-loader.js', 'bf238bfd-08f0-42c2-bb31-1920516f6f48');
</script>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-item">Facilities</div>
            <div class="sidebar-item active">Facility zones</div>
            <div class="sidebar-item">Facility categories</div>
            <div class="sidebar-item">Facility closures</div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="breadcrumb">
                <a href="#">Settings</a> / <a href="#">Facilities</a>
            </div>


            <div class="page-header">
                <div class="page-title-section">
                    <h1 class="page-title">Facility zones</h1>
                    <p class="page-description">
                        Facility zones ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum.
                    </p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="addZoneBtn">Add facility zone</button>
                    <button class="btn btn-secondary" id="currentFacilityBtn">
                        <span>üìç</span>
                        <span>Current facility</span>
                    </button>
                </div>
            </div>

            <!-- Zones Table -->
            <div class="zones-table">
                <div class="table-header">
                    <div>Zones</div>
                    <div>
                        Relations 
                        <span class="info-icon" id="relationsInfo">i</span>
                    </div>
                    <div>
                        Facility categories 
                        <span class="info-icon" id="categoriesInfo">i</span>
                    </div>
                    <div>Color</div>
                </div>
                <div id="zonesContainer">
                    <!-- Zones will be rendered here -->
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üìã</div>
                    <div class="empty-state-title">No facility zones yet</div>
                    <div class="empty-state-description">Create your first facility zone to get started</div>
                    <button class="btn btn-primary" onclick="openAddZoneDialog()">Add facility zone</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Zone Modal -->
    <div class="modal-overlay" id="zoneModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add facility zone</h2>
                <button class="close-btn" onclick="closeZoneModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="zoneForm">
                    <div class="form-group">
                        <label class="form-label">Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="zoneName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="zoneCategory">
                            <option value="">Select category</option>
                            <option value="swimming">Swimming</option>
                            <option value="personal-training">Personal Training</option>
                            <option value="parking">Parking</option>
                            <option value="yoga">Yoga</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Parent zone</label>
                        <select class="form-select" id="zoneParent">
                            <option value="">Top-level zone</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Relations</label>
                        <select class="form-select" id="zoneRelation">
                            <option value="">Add relation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-input" id="zoneColor">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeZoneModal()">Cancel</button>
                <button class="btn btn-primary" id="saveZoneBtn">Add zone</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Delete zone</h2>
                <button class="close-btn" onclick="closeDeleteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<strong id="deleteZoneName"></strong>"?</p>
                <p style="margin-top: 12px; color: #d32f2f; font-size: 14px;" id="deleteWarning"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-primary" style="background-color: #d32f2f;" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editZone()">Edit zone</div>
        <div class="context-menu-item danger" onclick="deleteZone()">Delete zone</div>
    </div>

    <!-- Popovers -->
    <div class="popover" id="relationsPopover">
<!--        <div class="popover-title">Relations</div>-->
        <div class="popover-content">
            The Zone relation describes two or more distinct <b>zones share a similar placement on the same larger terrain</b>.
        </div>
        <img src="images/relations.png" alt="Relations diagram" class="popover-image">
        <a href="#">More about zone relation</a>
    </div>

    <div class="popover" id="categoriesPopover">
<!--        <div class="popover-title">Facility categories</div>-->
        <div class="popover-content">
            The Facility Category allows a zone to be used as a <b>cross-facility resource</b> for various <b>Services</b>.
        </div>
        <a href="#">More about facility category</a>
    </div>

    <script>
        // Data structure
        let zones = [
            {
                id: 1,
                name: 'Fitness',
                category: '',
                parent: null,
                relation: null,
                color: '#a855f7',
                expanded: true
            },
            {
                id: 2,
                name: 'Gym Room 1',
                category: 'personal-training',
                parent: 1,
                relation: null,
                color: '#84cc16',
                expanded: false
            },
            {
                id: 3,
                name: 'Boxing room 1',
                category: 'personal-training',
                parent: 1,
                relation: null,
                color: '#c084fc',
                expanded: false
            },
            {
                id: 4,
                name: 'Yoga room 1',
                category: '',
                parent: 1,
                relation: null,
                color: '#06b6d4',
                expanded: false
            },
            {
                id: 5,
                name: 'Swimming Pools',
                category: '',
                parent: null,
                relation: null,
                color: '#3b82f6',
                expanded: true
            },
            {
                id: 6,
                name: 'Pool 1',
                category: '',
                parent: 5,
                relation: null,
                color: '#94a3b8',
                expanded: false
            },
            {
                id: 7,
                name: 'Pool 2',
                category: '',
                parent: 5,
                relation: null,
                color: '#f59e0b',
                expanded: true
            },
            {
                id: 8,
                name: 'Swimming lane 1',
                category: '',
                parent: 7,
                relation: 9,
                color: '#fde047',
                expanded: false
            },
            {
                id: 9,
                name: 'Swimming lane 2',
                category: '',
                parent: 7,
                relation: 8,
                color: '#ef4444',
                expanded: false
            },
            {
                id: 10,
                name: 'Swimming lane 3',
                category: 'swimming',
                parent: 7,
                relation: null,
                color: '#7f1d1d',
                expanded: false
            }
        ];

        let nextId = 11;
        let editingZoneId = null;
        let contextMenuZoneId = null;
        let expandedStates = {};

        const categories = {
            'swimming': { name: 'Swimming', color: '#ec4899' },
            'personal-training': { name: 'Personal Training', color: '#f97316' },
            'parking': { name: 'Parking', color: '#8b5cf6' },
            'yoga': { name: 'Yoga', color: '#10b981' }
        };

        // Initialize expanded states
        zones.forEach(zone => {
            expandedStates[zone.id] = zone.expanded !== false;
        });

        // Render zones
        function renderZones() {
            const container = document.getElementById('zonesContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (zones.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = '';

            const topLevelZones = zones.filter(z => z.parent === null);
            topLevelZones.forEach(zone => {
                renderZone(zone, 0, container);
            });
        }

        function renderZone(zone, level, container) {
            const row = document.createElement('div');
            row.className = 'zone-row';
            row.dataset.zoneId = zone.id;
            row.dataset.level = level;

            const children = zones.filter(z => z.parent === zone.id);
            const hasChildren = children.length > 0;
            const isExpanded = expandedStates[zone.id];

            // Zones column
            const zonesCell = document.createElement('div');
            zonesCell.className = `zone-cell zone-name-cell ${level > 0 ? `indent-${level}` : ''}`;
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = `toggle-btn ${!hasChildren ? 'hidden' : ''}`;
            toggleBtn.innerHTML = isExpanded ? '‚ñº' : '‚ñ∂';
            toggleBtn.onclick = () => toggleZone(zone.id);
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'zone-name';
            nameSpan.textContent = zone.name;
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-zone-btn';
            addBtn.innerHTML = '+';
            addBtn.onclick = () => openAddZoneDialog(zone.id);
            
            zonesCell.appendChild(toggleBtn);
            zonesCell.appendChild(nameSpan);
            zonesCell.appendChild(addBtn);

            // Relations column
            const relationsCell = document.createElement('div');
            relationsCell.className = 'zone-cell';
            if (zone.relation) {
                const relatedZone = zones.find(z => z.id === zone.relation);
                if (relatedZone) {
                    const badge = document.createElement('span');
                    badge.className = 'relation-badge';
                    badge.textContent = relatedZone.name;
                    relationsCell.appendChild(badge);
                }
            }

            // Category column
            const categoryCell = document.createElement('div');
            categoryCell.className = 'zone-cell';
            if (zone.category && categories[zone.category]) {
                const badge = document.createElement('span');
                badge.className = 'category-badge';
                
                const dot = document.createElement('span');
                dot.className = 'category-dot';
                dot.style.backgroundColor = categories[zone.category].color;
                
                badge.appendChild(dot);
                badge.appendChild(document.createTextNode(categories[zone.category].name));
                categoryCell.appendChild(badge);
            }

            // Color column
            const colorCell = document.createElement('div');
            colorCell.className = 'zone-cell';
            
            const colorCircle = document.createElement('div');
            colorCircle.className = 'color-circle';
            colorCircle.style.backgroundColor = zone.color;
            
            const menuBtn = document.createElement('button');
            menuBtn.className = 'menu-btn';
            menuBtn.innerHTML = '‚ãÆ';
            menuBtn.onclick = (e) => showContextMenu(e, zone.id);
            
            colorCell.appendChild(colorCircle);
            colorCell.appendChild(menuBtn);

            row.appendChild(zonesCell);
            row.appendChild(relationsCell);
            row.appendChild(categoryCell);
            row.appendChild(colorCell);

            if (!isExpanded) {
                row.classList.add('parent-collapsed');
            }

            container.appendChild(row);

            // Render children
            if (hasChildren && isExpanded) {
                children.forEach(child => {
                    renderZone(child, level + 1, container);
                });
            } else if (hasChildren && !isExpanded) {
                // Mark children as hidden
                children.forEach(child => {
                    markChildrenHidden(child);
                });
            }
        }

        function markChildrenHidden(zone) {
            const children = zones.filter(z => z.parent === zone.id);
            children.forEach(child => {
                markChildrenHidden(child);
            });
        }

        function toggleZone(zoneId) {
            expandedStates[zoneId] = !expandedStates[zoneId];
            renderZones();
        }

        // Context menu
        function showContextMenu(e, zoneId) {
            e.stopPropagation();
            const menu = document.getElementById('contextMenu');
            contextMenuZoneId = zoneId;
            
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        document.addEventListener('click', hideContextMenu);

        // Zone operations
        function openAddZoneDialog(parentId = null) {
            editingZoneId = null;
            document.getElementById('modalTitle').textContent = 'Add facility zone';
            document.getElementById('saveZoneBtn').textContent = 'Add zone';
            document.getElementById('zoneForm').reset();
            
            // Set random color
            document.getElementById('zoneColor').value = getRandomColor();
            
            // Update parent selector
            updateParentSelector(parentId);
            
            // Update relations selector
            updateRelationsSelector(null, parentId);
            
            if (parentId) {
                document.getElementById('zoneParent').value = parentId;
            }
            
            document.getElementById('zoneModal').classList.add('active');
        }

        function editZone() {
            hideContextMenu();
            const zone = zones.find(z => z.id === contextMenuZoneId);
            if (!zone) return;

            editingZoneId = zone.id;
            document.getElementById('modalTitle').textContent = 'Edit zone';
            document.getElementById('saveZoneBtn').textContent = 'Save changes';
            
            document.getElementById('zoneName').value = zone.name;
            document.getElementById('zoneCategory').value = zone.category || '';
            document.getElementById('zoneColor').value = zone.color;
            
            updateParentSelector(zone.parent, zone.id);
            document.getElementById('zoneParent').value = zone.parent || '';
            
            updateRelationsSelector(zone.relation, zone.parent, zone.id);
            document.getElementById('zoneRelation').value = zone.relation || '';
            
            document.getElementById('zoneModal').classList.add('active');
        }

        function closeZoneModal() {
            document.getElementById('zoneModal').classList.remove('active');
            editingZoneId = null;
        }

        function updateParentSelector(selectedParentId = null, excludeZoneId = null) {
            const select = document.getElementById('zoneParent');
            select.innerHTML = '<option value="">Top-level zone</option>';
            
            function addZoneOption(zone, level = 0) {
                if (excludeZoneId && (zone.id === excludeZoneId || isDescendant(zone.id, excludeZoneId))) {
                    return;
                }
                
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = '  '.repeat(level) + zone.name;
                select.appendChild(option);
                
                const children = zones.filter(z => z.parent === zone.id);
                children.forEach(child => addZoneOption(child, level + 1));
            }
            
            const topLevelZones = zones.filter(z => z.parent === null);
            topLevelZones.forEach(zone => addZoneOption(zone));
        }

        function isDescendant(zoneId, ancestorId) {
            let zone = zones.find(z => z.id === zoneId);
            while (zone && zone.parent) {
                if (zone.parent === ancestorId) return true;
                zone = zones.find(z => z.id === zone.parent);
            }
            return false;
        }

        function updateRelationsSelector(selectedRelation = null, parentId = null, excludeZoneId = null) {
            const select = document.getElementById('zoneRelation');
            select.innerHTML = '<option value="">Add relation</option>';
            
            // Get zones at the same level
            let eligibleZones;
            if (parentId) {
                eligibleZones = zones.filter(z => z.parent === parentId && z.id !== excludeZoneId && !z.relation);
            } else {
                eligibleZones = zones.filter(z => z.parent === null && z.id !== excludeZoneId && !z.relation);
            }
            
            eligibleZones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = zone.name;
                select.appendChild(option);
            });
        }

        document.getElementById('zoneParent').addEventListener('change', function() {
            const parentId = this.value ? parseInt(this.value) : null;
            updateRelationsSelector(null, parentId, editingZoneId);
        });

        document.getElementById('saveZoneBtn').addEventListener('click', function() {
            const name = document.getElementById('zoneName').value.trim();
            if (!name) {
                alert('Please enter a zone name');
                return;
            }

            const category = document.getElementById('zoneCategory').value;
            const parent = document.getElementById('zoneParent').value;
            const relation = document.getElementById('zoneRelation').value;
            const color = document.getElementById('zoneColor').value;

            if (editingZoneId) {
                // Edit existing zone
                const zone = zones.find(z => z.id === editingZoneId);
                const oldRelation = zone.relation;
                
                zone.name = name;
                zone.category = category;
                zone.parent = parent ? parseInt(parent) : null;
                zone.color = color;
                
                // Handle relation changes
                if (oldRelation && oldRelation !== relation) {
                    // Remove old relation
                    const oldRelatedZone = zones.find(z => z.id === oldRelation);
                    if (oldRelatedZone) {
                        oldRelatedZone.relation = null;
                    }
                }
                
                if (relation) {
                    zone.relation = parseInt(relation);
                    const relatedZone = zones.find(z => z.id === parseInt(relation));
                    if (relatedZone) {
                        relatedZone.relation = zone.id;
                    }
                } else {
                    zone.relation = null;
                }
            } else {
                // Add new zone
                const newZone = {
                    id: nextId++,
                    name: name,
                    category: category,
                    parent: parent ? parseInt(parent) : null,
                    relation: relation ? parseInt(relation) : null,
                    color: color,
                    expanded: true
                };
                
                if (parent) {
                    // Insert after parent's children
                    const parentZone = zones.find(z => z.id === parseInt(parent));
                    const siblings = zones.filter(z => z.parent === parseInt(parent));
                    const parentIndex = zones.indexOf(parentZone);
                    zones.splice(parentIndex + siblings.length + 1, 0, newZone);
                } else {
                    // Add to top
                    zones.unshift(newZone);
                }
                
                expandedStates[newZone.id] = true;
                
                // Set bidirectional relation
                if (relation) {
                    const relatedZone = zones.find(z => z.id === parseInt(relation));
                    if (relatedZone) {
                        relatedZone.relation = newZone.id;
                    }
                }
            }

            renderZones();
            closeZoneModal();
        });

        function deleteZone() {
            hideContextMenu();
            const zone = zones.find(z => z.id === contextMenuZoneId);
            if (!zone) return;

            document.getElementById('deleteZoneName').textContent = zone.name;
            
            const children = zones.filter(z => z.parent === zone.id);
            const warningEl = document.getElementById('deleteWarning');
            if (children.length > 0) {
                warningEl.textContent = `This will also delete ${children.length} child zone${children.length > 1 ? 's' : ''}.`;
            } else {
                warningEl.textContent = '';
            }
            
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const zone = zones.find(z => z.id === contextMenuZoneId);
            if (!zone) return;

            // Remove relation from related zone
            if (zone.relation) {
                const relatedZone = zones.find(z => z.id === zone.relation);
                if (relatedZone) {
                    relatedZone.relation = null;
                }
            }

            // Remove zone and all descendants
            function removeZoneAndChildren(zoneId) {
                const children = zones.filter(z => z.parent === zoneId);
                children.forEach(child => removeZoneAndChildren(child.id));
                zones = zones.filter(z => z.id !== zoneId);
            }

            removeZoneAndChildren(zone.id);
            renderZones();
            closeDeleteModal();
        });

        // Popovers
        function showPopover(e, popoverId) {
            e.stopPropagation();
            const popover = document.getElementById(popoverId);
            const rect = e.target.getBoundingClientRect();
            
            popover.style.left = (rect.left - 160) + 'px';
            popover.style.top = (rect.bottom + 8) + 'px';
            popover.classList.add('active');
        }

        function hidePopovers() {
            document.querySelectorAll('.popover').forEach(p => p.classList.remove('active'));
        }

        document.getElementById('relationsInfo').addEventListener('click', (e) => showPopover(e, 'relationsPopover'));
        document.getElementById('categoriesInfo').addEventListener('click', (e) => showPopover(e, 'categoriesPopover'));
        document.addEventListener('click', hidePopovers);

        // Utility functions
        function getRandomColor() {
            const colors = ['#a855f7', '#84cc16', '#c084fc', '#06b6d4', '#3b82f6', '#94a3b8', '#f59e0b', '#fde047', '#ef4444', '#7f1d1d', '#ec4899', '#f97316', '#8b5cf6', '#10b981'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Event listeners
        document.getElementById('addZoneBtn').addEventListener('click', () => openAddZoneDialog());

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // Initial render
        renderZones();
    </script>
</body>
</html>
