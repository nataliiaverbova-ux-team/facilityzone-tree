<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Zones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .sidebar {
            width: 200px;
            background: #fafafa;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            float: left;
            min-height: 1000px;
        }

        .sidebar h3 {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .sidebar-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .sidebar-item.active {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .main-content {
            margin-left: 200px;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .breadcrumb {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            max-width: 600px;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: white;
            color: #1976d2;
            border: 1px solid #1976d2;
        }

        .btn-secondary:hover {
            background: #e3f2fd;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #333;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background: #c62828;
        }

        .table-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
           
        }

        .table-header {
            display: grid;
            grid-template-columns: 40px 1fr 200px 200px 100px 40px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 13px;
            color: #666;
        }

        .table-header-cell {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .zone-row {
            display: grid;
            grid-template-columns: 40px 1fr 200px 200px 100px 40px;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
            transition: background 0.2s;
        }

        .zone-row:hover {
            background: #fafafa;
        }

        .zone-row.level-1 {
            padding-left: 60px;
        }

        .zone-row.level-2 {
            padding-left: 100px;
        }

        .zone-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .toggle-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
        }

        .toggle-btn:hover {
            color: #333;
        }

        .add-zone-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #1976d2;
            background: white;
            color: #1976d2;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
            transition: all 0.2s;
        }

        .add-zone-btn:hover {
            background: #1976d2;
            color: white;
        }

        .relations-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            background: #E3E4E8;
            color: #2D3648;
            display: inline-block;
        }

        .category-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

        .category-swimming {
            background: #e1f5fe;
            color: #0277bd;
        }

        .category-personal-training {
            background: #fff3e0;
            color: #e65100;
        }

        .category-parking {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .category-yoga {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .color-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #e0e0e0;
        }

        .context-menu-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 18px;
            position: relative;
        }

        .context-menu-btn:hover {
            background: #f5f5f5;
            border-radius: 4px;
        }

        .context-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 500;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-group label .required {
            color: #d32f2f;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1976d2;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #666;
            color: white;
            font-size: 12px;
            cursor: pointer;
            margin-left: 4px;
            position: relative;
        }

        .color-picker-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-preview {
            width: 60px;
            height: 40px;
            border-radius: 4px;
            border: 2px solid #e0e0e0;
            display: none;
        }

        .color-input {
            width: 60px!important;
            height: 60px;
            border: none;
            cursor: pointer;
            padding: 0px!important;
            cursor: pointer;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .multi-select-container {
            position: relative;
        }

        .multi-select-display {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 42px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .multi-select-display:focus-within {
            border-color: #1976d2;
        }

        .selected-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .remove-tag {
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .multi-select-dropdown.active {
            display: block;
        }

        .multi-select-option {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .multi-select-option:hover {
            background: #f5f5f5;
        }

        .multi-select-option.disabled {
            color: #999;
            cursor: not-allowed;
        }

        .multi-select-option.disabled:hover {
            background: white;
        }

        .popover {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            max-width: 340px;
            display: none;
        }

        .popover.active {
            display: block;
        }

        .popover-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .popover-content {
            font-size: 14px;
            line-height: 1.6;
            color: #666;
            
        }
        .popover img {
            margin-top: 16px;
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state-subtext {
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
                float: none;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                min-height: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .table-header,
            .zone-row {
                grid-template-columns: 40px 1fr 150px 150px 80px 40px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
            }

            .header-right {
                width: 100%;
                justify-content: flex-start;
            }

            .table-header {
                display: none;
            }

            .zone-row {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 16px;
            }

            .zone-row > div {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .zone-row > div::before {
                content: attr(data-label);
                font-weight: 600;
                font-size: 12px;
                color: #666;
                min-width: 100px;
            }

            .modal-content {
                width: 95%;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<script>
(function (m, a, z, e) {
  var s, t, u, v;
  try {
    t = m.sessionStorage.getItem('maze-us');
  } catch (err) {}

  if (!t) {
    t = new Date().getTime();
    try {
      m.sessionStorage.setItem('maze-us', t);
    } catch (err) {}
  }

  u = document.currentScript || (function () {
    var w = document.getElementsByTagName('script');
    return w[w.length - 1];
  })();
  v = u && u.nonce;

  s = a.createElement('script');
  s.src = z + '?apiKey=' + e;
  s.async = true;
  if (v) s.setAttribute('nonce', v);
  a.getElementsByTagName('head')[0].appendChild(s);
  m.mazeUniversalSnippetApiKey = e;
})(window, document, 'https://snippet.maze.co/maze-universal-loader.js', 'bf238bfd-08f0-42c2-bb31-1920516f6f48');
</script>

<body>
    <div class="container">
        <div class="sidebar">
            <h3>Facilities</h3>
            <div class="sidebar-item active">Facility zones</div>
            <div class="sidebar-item">Facility categories</div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <div class="breadcrumb">Settings / Facilities</div>
                    <h1>Facility zones</h1>
                    <p class="description">Facility zones ipsum dolor sit amet, consectetur adipiscing elit, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum.</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openAddZoneModal()">Add facility zone</button>
                    <button class="btn btn-secondary">Current facility</button>
                </div>
            </div>

            <div id="tableContainer" class="table-container">
                <div class="table-header">
                    <div class="table-header-cell"></div>
                    <div class="table-header-cell">Zones</div>
                    <div class="table-header-cell">
                        Relations
                        <span class="info-icon" onclick="showDescription(event, 'relations')">i</span>
                    </div>
                    <div class="table-header-cell">
                        Facility categories
                        <span class="info-icon" onclick="showDescription(event, 'categories')">i</span>
                    </div>
                    <div class="table-header-cell">Color</div>
                    <div class="table-header-cell"></div>
                </div>
                <div id="zonesList"></div>
            </div>

            <div id="emptyState" class="empty-state hidden">
                <div class="empty-state-icon">ðŸ“‹</div>
                <div class="empty-state-text">No facility zones yet</div>
                <div class="empty-state-subtext">Click "Add facility zone" to create your first zone</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Zone Modal -->
    <div id="zoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add facility zone</h2>
                <button class="close-btn" onclick="closeZoneModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="zoneForm">
                    <input type="hidden" id="zoneId" value="">
                    <input type="hidden" id="parentZoneId" value="">
                    
                    <div class="form-group">
                        <label>Name <span class="required">*</span></label>
                        <input type="text" id="zoneName" required>
                    </div>

                    <div class="form-group">
                        <label>
                            Category
                            <span class="info-icon" onclick="showDescription(event, 'categories')">i</span>
                        </label>
                        <select id="zoneCategory">
                            <option value="">Select category</option>
                            <option value="swimming">Swimming</option>
                            <option value="personal-training">Personal Training</option>
                            <option value="parking">Parking</option>
                            <option value="yoga">Yoga</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Parent zone</label>
                        <select id="parentZoneSelect">
                            <option value="">Top-level zone</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            Relations
                            <span class="info-icon" onclick="showDescription(event, 'relations')">i</span>
                        </label>
                        <div class="multi-select-container">
                            <div class="multi-select-display" id="relationsDisplay" onclick="toggleRelationsDropdown()">
                                <span style="color: #999; font-size: 14px;" id="relationsPlaceholder">Select relations</span>
                            </div>
                            <div class="multi-select-dropdown" id="relationsDropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Color</label>
                        <div class="color-picker-container">
                            <div class="color-preview" id="colorPreview" onclick="document.getElementById('zoneColor').click()"></div>
                            <input type="color" id="zoneColor" class="color-input">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeZoneModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveZone()">Add zone</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete zone</h2>
                <button class="close-btn" onclick="closeDeleteModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteZoneName"></span>"? This action cannot be undone.</p>
                <p style="margin-top: 10px; color: #d32f2f; font-size: 14px;" id="deleteWarning"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Popovers -->
    <div id="relationsPopover" class="popover">
<!--        <div class="popover-title">Relations</div>-->
        <div class="popover-content">
            The relation describes two or more distinct zones that share <b>a similar placement within the same larger terrain.</b> This relation influences the booking of facility zones â€” for example, if the basketball zone is booked, the related zone will not be available for booking.
        </div>
        <img src="images/relations.png" alt="The relation zones">
    </div>

    <div id="categoriesPopover" class="popover">
<!--        <div class="popover-title">Facility Category</div>-->
        <div class="popover-content">
            A Facility Category can be assigned to a zone, <b>allowing that zone to be linked to various Services</b> as a cross-facility resource.
        </div>
    </div>

    <script>
        // Data structure
        let zones = [];
        let expandedZones = new Set();
        let currentEditingZone = null;
        let currentDeletingZone = null;
        let selectedRelations = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // âœ… Expand all zones (or only top-level zones) on first load
            if (expandedZones.size === 0) {
                // Option 1: Expand all zones
                zones.forEach(zone => expandedZones.add(zone.id));

                // OR, if you only want top-level zones expanded:
                // zones.filter(z => !z.parentId).forEach(zone => expandedZones.add(zone.id));
            }
            
            renderZones();
            
            // Update color preview when color changes
            document.getElementById('zoneColor').addEventListener('input', function() {
                document.getElementById('colorPreview').style.backgroundColor = this.value;
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.multi-select-container')) {
                    document.getElementById('relationsDropdown').classList.remove('active');
                }
                if (!e.target.closest('.info-icon') && !e.target.closest('.popover')) {
                    closeAllPopovers();
                }
                if (!e.target.closest('.context-menu-btn') && !e.target.closest('.context-menu')) {
                    closeAllContextMenus();
                }
            });
        });

        // Load data from localStorage
        function loadData() {
            const savedZones = localStorage.getItem('facilityZones');
            const savedExpanded = localStorage.getItem('expandedZones');
            
            if (savedZones) {
                zones = JSON.parse(savedZones);
            } else {
                // Initial demo data
                zones = [
                    {
                        id: 'zone-1',
                        name: 'Fitness',
                        category: '',
                        color: '#a855f7',
                        parentId: null,
                        relations: []
                    },
                    {
                        id: 'zone-2',
                        name: 'Gym room',
                        category: 'personal-training',
                        color: '#a0d468',
                        parentId: 'zone-1',
                        relations: []
                    },
                    {
                        id: 'zone-3',
                        name: 'Boxing room',
                        category: '',
                        color: '#5f9ea0',
                        parentId: 'zone-1',
                        relations: []
                    },
                    {
                        id: 'zone-4',
                        name: 'Swimming Pool',
                        category: '',
                        color: '#4fc3f7',
                        parentId: null,
                        relations: []
                    },
                    {
                        id: 'zone-5',
                        name: 'Swimming lane 1',
                        category: '',
                        color: '#808080',
                        parentId: 'zone-4',
                        relations: []
                    },
                    {
                        id: 'zone-6',
                        name: 'Swimming lane 2',
                        category: '',
                        color: '#ffa726',
                        parentId: 'zone-4',
                        relations: []
                    }
                ];
                saveData();
            }
            
            if (savedExpanded) {
                expandedZones = new Set(JSON.parse(savedExpanded));
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('facilityZones', JSON.stringify(zones));
            localStorage.setItem('expandedZones', JSON.stringify([...expandedZones]));
        }

        // Generate random color
        function generateRandomColor() {
            const colors = ['#a855f7', '#a0d468', '#5f9ea0', '#4fc3f7', '#808080', '#ffa726', '#ef5350', '#66bb6a', '#42a5f5', '#ab47bc'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Get category display name
        function getCategoryName(category) {
            const names = {
                'swimming': 'Swimming',
                'personal-training': 'Personal Training',
                'parking': 'Parking',
                'yoga': 'Yoga'
            };
            return names[category] || category;
        }

        // Get zone level
        function getZoneLevel(zoneId) {
            let level = 0;
            let currentZone = zones.find(z => z.id === zoneId);
            
            while (currentZone && currentZone.parentId) {
                level++;
                currentZone = zones.find(z => z.id === currentZone.parentId);
            }
            
            return level;
        }

        // Get children of a zone
        function getChildren(parentId) {
            return zones.filter(z => z.parentId === parentId);
        }

        // Check if zone has children
        function hasChildren(zoneId) {
            return zones.some(z => z.parentId === zoneId);
        }

        // Get all descendants of a zone
        function getAllDescendants(zoneId) {
            let descendants = [];
            const children = getChildren(zoneId);
            
            children.forEach(child => {
                descendants.push(child);
                descendants = descendants.concat(getAllDescendants(child.id));
            });
            
            return descendants;
        }

        // Get siblings (zones at the same level with same parent)
        function getSiblings(zoneId) {
            const zone = zones.find(z => z.id === zoneId);
            if (!zone) return [];
            
            return zones.filter(z => z.id !== zoneId && z.parentId === zone.parentId);
        }

        // Render zones
        function renderZones() {
            const container = document.getElementById('zonesList');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.getElementById('tableContainer');
            
            if (zones.length === 0) {
                tableContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            tableContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            container.innerHTML = '';
            
            // Render top-level zones first
            const topLevelZones = zones.filter(z => !z.parentId);
            topLevelZones.forEach(zone => {
                renderZone(zone, container, 0);
            });
        }

        // Render a single zone and its children
        function renderZone(zone, container, level) {
            const children = getChildren(zone.id);
            const isExpanded = expandedZones.has(zone.id);
            const hasChild = children.length > 0;
            
            const row = document.createElement('div');
            row.className = `zone-row level-${level}`;
            row.dataset.zoneId = zone.id;
            
            // Toggle button
            const toggleCell = document.createElement('div');
            if (hasChild) {
                toggleCell.innerHTML = `<button class="toggle-btn" onclick="toggleZone('${zone.id}')">${isExpanded ? 'â–¼' : 'â–¶'}</button>`;
            }
            row.appendChild(toggleCell);
            
            // Zone name with add button
            const nameCell = document.createElement('div');
            nameCell.className = 'zone-name';
            nameCell.innerHTML = `
                <span>${zone.name}</span>
                ${level < 2 ? `<button class="add-zone-btn" onclick="openAddSubZoneModal('${zone.id}')">+</button>` : ''}
            `;
            row.appendChild(nameCell);
            
            // Relations
            const relationsCell = document.createElement('div');
            relationsCell.className = 'relations-cell';
            relationsCell.setAttribute('data-label', 'Relations:');
            if (zone.relations && zone.relations.length > 0) {
                zone.relations.forEach(relId => {
                    const relZone = zones.find(z => z.id === relId);
                    if (relZone) {
                        const badge = document.createElement('span');
                        badge.className = 'badge';
                        badge.textContent = relZone.name;
                        relationsCell.appendChild(badge);
                    }
                });
            }
            row.appendChild(relationsCell);
            
            // Category
            const categoryCell = document.createElement('div');
            categoryCell.setAttribute('data-label', 'Category:');
            if (zone.category) {
                categoryCell.innerHTML = `<span class="category-badge category-${zone.category}">${getCategoryName(zone.category)}</span>`;
            }
            row.appendChild(categoryCell);
            
            // Color
            const colorCell = document.createElement('div');
            colorCell.setAttribute('data-label', 'Color:');
            colorCell.innerHTML = `<div class="color-indicator" style="background-color: ${zone.color}"></div>`;
            row.appendChild(colorCell);
            
            // Context menu
            const menuCell = document.createElement('div');
            menuCell.style.position = 'relative';
            menuCell.innerHTML = `
                <button class="context-menu-btn" onclick="toggleContextMenu(event, '${zone.id}')">â‹®</button>
                <div class="context-menu" id="contextMenu-${zone.id}">
                    <div class="context-menu-item" onclick="editZone('${zone.id}')">Edit zone</div>
                    <div class="context-menu-item danger" onclick="deleteZone('${zone.id}')">Delete zone</div>
                </div>
            `;
            row.appendChild(menuCell);
            
            container.appendChild(row);
            
            // Render children if expanded
            if (isExpanded && hasChild) {
                children.forEach(child => {
                    renderZone(child, container, level + 1);
                });
            }
        }

        // Toggle zone expansion
        function toggleZone(zoneId) {
            if (expandedZones.has(zoneId)) {
                expandedZones.delete(zoneId);
            } else {
                expandedZones.add(zoneId);
            }
            saveData();
            renderZones();
        }

        // Open add zone modal
        function openAddZoneModal() {
            currentEditingZone = null;
            document.getElementById('modalTitle').textContent = 'Add facility zone';
            document.getElementById('zoneForm').reset();
            document.getElementById('zoneId').value = '';
            document.getElementById('parentZoneId').value = '';
            
            const randomColor = generateRandomColor();
            document.getElementById('zoneColor').value = randomColor;
            document.getElementById('colorPreview').style.backgroundColor = randomColor;
            
            selectedRelations = [];
            updateParentZoneOptions();
            updateRelationsDisplay();
            
            document.querySelector('.modal-footer .btn-primary').textContent = 'Add zone';
            document.getElementById('zoneModal').classList.add('active');
        }

        // Open add sub-zone modal
        function openAddSubZoneModal(parentId) {
            currentEditingZone = null;
            document.getElementById('modalTitle').textContent = 'Add facility zone';
            document.getElementById('zoneForm').reset();
            document.getElementById('zoneId').value = '';
            document.getElementById('parentZoneId').value = parentId;
            
            const randomColor = generateRandomColor();
            document.getElementById('zoneColor').value = randomColor;
            document.getElementById('colorPreview').style.backgroundColor = randomColor;
            
            selectedRelations = [];
            updateParentZoneOptions(parentId);
            updateRelationsDisplay();
            
            document.querySelector('.modal-footer .btn-primary').textContent = 'Add zone';
            document.getElementById('zoneModal').classList.add('active');
        }

        // Update parent zone options
        function updateParentZoneOptions(selectedParentId = null) {
            const select = document.getElementById('parentZoneSelect');
            const currentZoneId = document.getElementById('zoneId').value;
            
            select.innerHTML = '<option value="">Top-level zone</option>';
            
            zones.forEach(zone => {
                // Don't allow selecting the current zone or its descendants as parent
                if (currentZoneId) {
                    const descendants = getAllDescendants(currentZoneId);
                    if (zone.id === currentZoneId || descendants.some(d => d.id === zone.id)) {
                        return;
                    }
                }
                
                // Only allow up to 2 levels of nesting
                const level = getZoneLevel(zone.id);
                if (level < 2) {
                    const indent = '  '.repeat(level);
                    const option = document.createElement('option');
                    option.value = zone.id;
                    option.textContent = indent + zone.name;
                    select.appendChild(option);
                }
            });
            
            if (selectedParentId) {
                select.value = selectedParentId;
            }
        }

        // Update relations dropdown
        function updateRelationsDropdown() {
            const dropdown = document.getElementById('relationsDropdown');
            const currentZoneId = document.getElementById('zoneId').value;
            const parentId = document.getElementById('parentZoneSelect').value;
            
            dropdown.innerHTML = '';
            
            // Get available zones (siblings only)
            let availableZones = [];
            if (currentZoneId) {
                availableZones = getSiblings(currentZoneId);
            } else if (parentId) {
                availableZones = zones.filter(z => z.parentId === parentId);
            } else {
                availableZones = zones.filter(z => !z.parentId);
            }
            
            if (availableZones.length === 0) {
                const option = document.createElement('div');
                option.className = 'multi-select-option disabled';
                option.textContent = 'No zones available';
                dropdown.appendChild(option);
                return;
            }
            
            availableZones.forEach(zone => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.textContent = zone.name;
                option.onclick = () => toggleRelationSelection(zone.id);
                
                if (selectedRelations.includes(zone.id)) {
                    option.style.backgroundColor = '#e3f2fd';
                }
                
                dropdown.appendChild(option);
            });
        }

        // Toggle relations dropdown
        function toggleRelationsDropdown() {
            const dropdown = document.getElementById('relationsDropdown');
            updateRelationsDropdown();
            dropdown.classList.toggle('active');
        }

        // Toggle relation selection
        function toggleRelationSelection(zoneId) {
            const index = selectedRelations.indexOf(zoneId);
            if (index > -1) {
                selectedRelations.splice(index, 1);
            } else {
                selectedRelations.push(zoneId);
            }
            updateRelationsDisplay();
            updateRelationsDropdown();
        }

        // Update relations display
        function updateRelationsDisplay() {
            const display = document.getElementById('relationsDisplay');
            const placeholder = document.getElementById('relationsPlaceholder');
            
            display.innerHTML = '';
            
            if (selectedRelations.length === 0) {
                const ph = document.createElement('span');
                ph.id = 'relationsPlaceholder';
                ph.style.color = '#999';
                ph.style.fontSize = '14px';
                ph.textContent = 'Select relations';
                display.appendChild(ph);
            } else {
                selectedRelations.forEach(relId => {
                    const zone = zones.find(z => z.id === relId);
                    if (zone) {
                        const tag = document.createElement('div');
                        tag.className = 'selected-tag';
                        tag.innerHTML = `
                            ${zone.name}
                            <span class="remove-tag" onclick="event.stopPropagation(); toggleRelationSelection('${relId}')">Ã—</span>
                        `;
                        display.appendChild(tag);
                    }
                });
            }
        }

        // Watch for parent zone changes
        document.addEventListener('DOMContentLoaded', function() {
            const parentSelect = document.getElementById('parentZoneSelect');
            if (parentSelect) {
                parentSelect.addEventListener('change', function() {
                    selectedRelations = [];
                    updateRelationsDisplay();
                });
            }
        });

        // Close zone modal
        function closeZoneModal() {
            document.getElementById('zoneModal').classList.remove('active');
            selectedRelations = [];
        }

        // Save zone
        function saveZone() {
            const name = document.getElementById('zoneName').value.trim();
            const category = document.getElementById('zoneCategory').value;
            const parentId = document.getElementById('parentZoneSelect').value || null;
            const color = document.getElementById('zoneColor').value;
            const zoneId = document.getElementById('zoneId').value;
            
            if (!name) {
                alert('Please enter a zone name');
                return;
            }
            
            if (zoneId) {
                // Edit existing zone
                const zone = zones.find(z => z.id === zoneId);
                if (zone) {
                    // Remove old relations
                    zone.relations.forEach(oldRelId => {
                        const relZone = zones.find(z => z.id === oldRelId);
                        if (relZone) {
                            relZone.relations = relZone.relations.filter(id => id !== zoneId);
                        }
                    });
                    
                    zone.name = name;
                    zone.category = category;
                    zone.color = color;
                    zone.relations = [...selectedRelations];
                    
                    // Add new relations
                    selectedRelations.forEach(relId => {
                        const relZone = zones.find(z => z.id === relId);
                        if (relZone && !relZone.relations.includes(zoneId)) {
                            relZone.relations.push(zoneId);
                        }
                    });
                }
            } else {
                // Add new zone
                const newZone = {
                    id: 'zone-' + Date.now(),
                    name: name,
                    category: category,
                    color: color,
                    parentId: parentId,
                    relations: [...selectedRelations]
                };
                
                zones.push(newZone);
                
                // Add reciprocal relations
                selectedRelations.forEach(relId => {
                    const relZone = zones.find(z => z.id === relId);
                    if (relZone) {
                        relZone.relations.push(newZone.id);
                    }
                });
                
                // Expand parent if adding a sub-zone
                if (parentId) {
                    expandedZones.add(parentId);
                }
            }
            
            saveData();
            renderZones();
            closeZoneModal();
        }

        // Edit zone
        function editZone(zoneId) {
            closeAllContextMenus();
            
            const zone = zones.find(z => z.id === zoneId);
            if (!zone) return;
            
            currentEditingZone = zone;
            
            document.getElementById('modalTitle').textContent = 'Edit zone';
            document.getElementById('zoneId').value = zone.id;
            document.getElementById('zoneName').value = zone.name;
            document.getElementById('zoneCategory').value = zone.category || '';
            document.getElementById('zoneColor').value = zone.color;
            document.getElementById('colorPreview').style.backgroundColor = zone.color;
            
            selectedRelations = [...(zone.relations || [])];
            
            updateParentZoneOptions(zone.parentId);
            document.getElementById('parentZoneSelect').value = zone.parentId || '';
            updateRelationsDisplay();
            
            document.querySelector('.modal-footer .btn-primary').textContent = 'Save changes';
            document.getElementById('zoneModal').classList.add('active');
        }

        // Delete zone
        function deleteZone(zoneId) {
            closeAllContextMenus();
            
            const zone = zones.find(z => z.id === zoneId);
            if (!zone) return;
            
            currentDeletingZone = zoneId;
            
            document.getElementById('deleteZoneName').textContent = zone.name;
            
            const children = getAllDescendants(zoneId);
            const warning = document.getElementById('deleteWarning');
            
            if (children.length > 0) {
                warning.textContent = `This will also delete ${children.length} sub-zone${children.length > 1 ? 's' : ''}.`;
            } else {
                warning.textContent = '';
            }
            
            document.getElementById('deleteModal').classList.add('active');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            currentDeletingZone = null;
        }

        // Confirm delete
        function confirmDelete() {
            if (!currentDeletingZone) return;
            
            const zone = zones.find(z => z.id === currentDeletingZone);
            if (!zone) return;
            
            // Get all zones to delete (including descendants)
            const zonesToDelete = [zone, ...getAllDescendants(currentDeletingZone)];
            const zoneIdsToDelete = zonesToDelete.map(z => z.id);
            
            // Remove relations to these zones
            zones.forEach(z => {
                if (z.relations) {
                    z.relations = z.relations.filter(relId => !zoneIdsToDelete.includes(relId));
                }
            });
            
            // Remove the zones
            zones = zones.filter(z => !zoneIdsToDelete.includes(z.id));
            
            // Remove from expanded set
            zoneIdsToDelete.forEach(id => expandedZones.delete(id));
            
            saveData();
            renderZones();
            closeDeleteModal();
        }

        // Toggle context menu
        function toggleContextMenu(event, zoneId) {
            event.stopPropagation();
            closeAllContextMenus();
            
            const menu = document.getElementById(`contextMenu-${zoneId}`);
            menu.classList.add('active');
        }

        // Close all context menus
        function closeAllContextMenus() {
            document.querySelectorAll('.context-menu').forEach(menu => {
                menu.classList.remove('active');
            });
        }

        // Toggle popover
        function showDescription(event, type) {
            event.stopPropagation();
            closeAllPopovers();
            
            const popover = document.getElementById(type + 'Popover');
            const rect = event.target.getBoundingClientRect();
            
            popover.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            popover.style.left = (rect.left + window.scrollX - 140) + 'px';
            popover.classList.add('active');
        }

        // Close all popovers
        function closeAllPopovers() {
            document.querySelectorAll('.popover').forEach(popover => {
                popover.classList.remove('active');
            });
        }
    </script>
</body>
</html>
